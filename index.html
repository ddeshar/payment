<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üèóÔ∏è ‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô (Dashboard)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>    /* --------------  Core layout  -------------- */
    :root {
      --card-bg: #ffffff;
      --card-radius: 20px;
      --shadow: 0 8px 32px rgba(0,0,0,.1);
      --shadow-hover: 0 12px 40px rgba(0,0,0,.15);
      --primary: #667eea;      /* Beautiful blue gradient start */
      --primary-dark: #764ba2; /* Beautiful blue gradient end */
      --accent: #06d6a0;      /* Modern teal */
      --accent-dark: #048a65;  /* Darker teal */
      --danger: #ff6b6b;      /* Soft red */
      --danger-dark: #ee5a52; /* Darker red */
      --text: #2d3748;        /* Warm dark gray */
      --subtext: #718096;     /* Medium gray */
      --border: #e2e8f0;      /* Light gray */
      --bg-primary: #f7fafc;  /* Very light gray */
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #06d6a0 0%, #048a65 100%);
      --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    }
    
    * { 
      box-sizing: border-box; 
    }
    
    body {
      margin: 0;
      font-family: 'Kanit', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      line-height: 1.6;
      font-weight: 400;
    }
    
    h1 {
      font-size: 2.5rem;
      font-weight: 600;
      text-align: center;
      margin: 2rem 0;
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h2, h3, h4 {
      font-weight: 500;
    }    /* --------------  Navigation  -------------- */
    .nav-container {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      margin: 0 2rem 3rem;
      border-radius: var(--card-radius);
      padding: 1.5rem;
      backdrop-filter: blur(10px);
    }
    
    .nav-tabs {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .nav-tab {
      background: transparent;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 1rem 1.75rem;
      font-size: 0.95rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text);
      position: relative;
      overflow: hidden;
      min-width: 140px;
      text-align: center;
    }
    
    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--bg-gradient);
      transition: left 0.3s ease;
      z-index: -1;
    }
    
    .nav-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    }
    
    .nav-tab.active {
      background: var(--bg-gradient);
      color: white;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .nav-tab.active::before {
      left: 0;
    }

    /* --------------  Dashboard sections  -------------- */
    .dashboard-section {
      display: none;
    }
    .dashboard-section.active {
      display: block;
    }    #dashboard {
      padding: 0 2rem 3rem;
    }
    
    .section-header {
      text-align: center;
      margin: 3rem 0 2rem;
      padding: 2rem;
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .section-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }
    
    .section-header.customer::before {
      background: var(--success-gradient);
    }
    
    .section-header.vendor::before {
      background: var(--danger-gradient);
    }
    
    .section-header h2 {
      margin: 0 0 1rem;
      font-size: 2.2rem;
      font-weight: 600;
    }
    
    .section-header.customer h2 {
      color: var(--accent);
    }
    
    .section-header.vendor h2 {
      color: var(--danger);
    }
    
    .section-header p {
      margin: 0;
      color: var(--subtext);
      font-size: 1.1rem;
    }
    
    .contracts-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      margin-bottom: 3rem;
    }
    
    .contracts-grid.customer {
      justify-content: center;
    }
    
    .contracts-grid.vendor {
      justify-content: center;
    }    /* --------------  Contract card  -------------- */
    .contract {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      flex: 1 1 340px;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      transition: all .3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .contract.customer-card {
      max-width: 100%;
      flex: 1 1 100%;
      margin: 0 2rem;
    }
    
    .contract::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--bg-gradient);
    }
    
    .contract:hover { 
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-hover);
    }

    .contract h2 {
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0 0 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .total {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .total.customer {
      background: var(--success-gradient);
      color: white;
    }
    
    .total.vendor {
      background: var(--danger-gradient);
      color: white;
    }    /* --------------  Progress bar  -------------- */
    .progress-bar {
      height: 12px;
      width: 100%;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.3) 0%, 
        rgba(255,255,255,0) 50%, 
        rgba(255,255,255,0.3) 100%);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-bar-inner {
      height: 100%;
      background: var(--bg-gradient);
      width: 0;
      transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 8px;
      position: relative;
    }    /* --------------  Milestones  -------------- */
    .milestone {
      background: rgba(102, 126, 234, 0.05);
      border-left: 4px solid var(--primary);
      border-radius: 0 12px 12px 0;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .milestone:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: translateX(4px);
    }
    
    .milestone .head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .milestone .head span:first-child {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .milestone .percent {
      background: var(--bg-gradient);
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      white-space: nowrap;
      min-width: 60px;
      text-align: center;
    }
      .milestone .amount {
      font-weight: 600;
      font-size: 1rem;
      color: var(--primary-dark);
      margin: 0.5rem 0 0;
    }
    
    .milestone p {
      margin: 0.5rem 0 0;
      font-size: 0.9rem;
      color: var(--subtext);
      white-space: pre-line;
      line-height: 1.5;
    }
    
    .payment-date {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .payment-date.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .payment-date.urgent {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .payment-date.soon {
      background: rgba(59, 130, 246, 0.1);
      color: #2563eb;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .payment-date.normal {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }/* --------------  Summary Dashboard  -------------- */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      padding: 0 2rem 3rem;
    }
    
    .summary-card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 2.5rem 2rem;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--bg-gradient);
    }
    
    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .summary-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }
    
    .summary-number {
      font-size: 2.75rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .summary-label {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 1rem;
    }
    
    .summary-detail {
      font-size: 0.95rem;
      color: var(--subtext);
      line-height: 1.5;
    }    /* --------------  Chart Dashboard  -------------- */
    .chart-container {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 2.5rem;
      margin: 0 2rem 2rem;
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      box-shadow: var(--shadow-hover);
    }
    
    .chart {
      height: 320px;
      display: flex;
      align-items: end;
      gap: 1.5rem;
      padding: 1.5rem 0;
      border-bottom: 2px solid var(--border);
    }
    
    .chart-bar {
      flex: 1;
      background: var(--bg-gradient);
      border-radius: 8px 8px 0 0;
      min-height: 20px;
      position: relative;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    
    .chart-bar:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }
    
    .chart-bar-label {
      position: absolute;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      width: 120px;
    }
    
    .chart-bar-value {
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* --------------  Small screens  -------------- */
    @media (max-width: 500px) {
      .contract { flex: 1 1 100%; }
      .nav-container { margin: 0 1rem 2rem; }
      #dashboard { padding: 0 1rem 3rem; }
      .summary-grid { padding: 0 1rem 3rem; }
      .chart-container { margin: 0 1rem 2rem; }
    }
  </style>
</head>
<body>

  <h1>‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</h1>
  
  <div class="nav-container">    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showDashboard('detailed')">
        üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
      </button>
      <button class="nav-tab" onclick="showDashboard('summary')">
        üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
      </button>
      <button class="nav-tab" onclick="showDashboard('chart')">
        üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
      </button>
      <button class="nav-tab" onclick="showDashboard('timeline')">
        ‚è∞ ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö
      </button>
      <button class="nav-tab" onclick="showDashboard('cashflow')">
        üí∏ ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
      </button>
    </div>
  </div>

  <!-- Detailed Dashboard -->
  <div id="detailed-dashboard" class="dashboard-section active">
    <div id="dashboard"></div>
  </div>

  <!-- Summary Dashboard -->
  <div id="summary-dashboard" class="dashboard-section">
    <div class="summary-grid" id="summary-grid"></div>
  </div>

  <!-- Chart Dashboard -->
  <div id="chart-dashboard" class="dashboard-section">
    <div class="chart-container">
      <h2 style="margin-top: 0;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
      <div class="chart" id="contract-chart"></div>
    </div>
  </div>

  <!-- Timeline Dashboard -->
  <div id="timeline-dashboard" class="dashboard-section">
    <div id="timeline-container"></div>
  </div>

  <!-- Cash Flow Dashboard -->
  <div id="cashflow-dashboard" class="dashboard-section">
    <div id="cashflow-container"></div>
  </div>

  <script>
    let contractsData = [];

    /* ---------  Load JSON + render  --------- */
    fetch('milestones.json')
      .then(r => r.json())
      .then(data => {
        contractsData = data.contracts;
        buildDetailedDashboard(contractsData);
        buildSummaryDashboard(contractsData);
        buildChartDashboard(contractsData);
        buildTimelineDashboard(contractsData);
        buildCashFlowDashboard(contractsData);
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('dashboard').innerHTML = 
          '<div style="text-align: center; color: red; padding: 2rem;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      });

    /* ---------  Dashboard Navigation  --------- */
    function showDashboard(type) {
      // Hide all sections
      document.querySelectorAll('.dashboard-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(type + '-dashboard').classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }    /* ---------  Detailed Dashboard (Original)  --------- */
    function buildDetailedDashboard(contracts) {
      const dash = document.getElementById('dashboard');
      dash.innerHTML = '';

      // Separate customer and vendors
      const customer = contracts.find(c => c.name === 'BRS');
      const vendors = contracts.filter(c => c.name !== 'BRS');

      // Add customer section
      if (customer) {
        // Customer header
        const customerHeader = document.createElement('div');
        customerHeader.className = 'section-header customer';
        customerHeader.innerHTML = `
          <h2>üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
          <p>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</p>
        `;
        dash.appendChild(customerHeader);

        // Customer card container
        const customerContainer = document.createElement('div');
        customerContainer.className = 'contracts-grid customer';
        const card = createContractCard(customer, 'customer');
        customerContainer.appendChild(card);
        dash.appendChild(customerContainer);
      }

      // Add vendors section
      if (vendors.length > 0) {
        // Vendors header
        const vendorHeader = document.createElement('div');
        vendorHeader.className = 'section-header vendor';
        vendorHeader.innerHTML = `
          <h2>üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</h2>
          <p>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</p>
        `;
        dash.appendChild(vendorHeader);

        // Vendors card container
        const vendorContainer = document.createElement('div');
        vendorContainer.className = 'contracts-grid vendor';
        vendors.forEach(vendor => {
          const card = createContractCard(vendor, 'vendor');
          vendorContainer.appendChild(card);
        });
        dash.appendChild(vendorContainer);
      }
    }    function createContractCard(contract, type) {
      const card = document.createElement('section');
      card.className = 'contract';
      
      const isCustomer = type === 'customer';
      
      // Add customer-card class for full width
      if (isCustomer) {
        card.classList.add('customer-card');
      }
      
      const borderColor = isCustomer ? 'var(--accent)' : 'var(--danger)';
      const icon = isCustomer ? 'üè¢' : 'üèóÔ∏è';
      const label = isCustomer ? '‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö' : '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢';
      const bgGradient = isCustomer ? 'var(--success-gradient)' : 'var(--danger-gradient)';
      
      card.style.borderLeft = `4px solid ${borderColor}`;

      /* Header + total */
      card.innerHTML = `
        <h2>${icon} ${contract.name}</h2>
        <div class="total ${type}" style="background: ${bgGradient};">
          <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">${label}</div>
          <div style="font-size: 1.25rem; font-weight: 700;">${fmt(contract.total)} ‡∏ö‡∏≤‡∏ó</div>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-inner" style="background: ${bgGradient};"></div>
        </div>
        <div class="milestones"></div>
      `;      /* Milestone list */
      const list = card.querySelector('.milestones');
      let cumulative = 0;
      contract.milestones.forEach((ms, index) => {
        cumulative += ms.percent;
        const milestoneIcon = getMilestoneIcon(index + 1);
        
        // Format payment date for vendors only
        let paymentDateHtml = '';
        if (!isCustomer && ms.paymentDate) {
          const dateInfo = formatDate(ms.paymentDate);
          paymentDateHtml = `
            <div class="payment-date ${dateInfo.class}">
              ${dateInfo.icon} ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢: ${dateInfo.formatted}
              ${dateInfo.daysLeft >= 0 ? `(‡∏≠‡∏µ‡∏Å ${dateInfo.daysLeft} ‡∏ß‡∏±‡∏ô)` : `(‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(dateInfo.daysLeft)} ‡∏ß‡∏±‡∏ô)`}
            </div>
          `;
        }
        
        list.insertAdjacentHTML('beforeend', `
          <div class="milestone" style="border-left-color: ${borderColor};">
            <div class="head">
              <span>${milestoneIcon} ‡∏á‡∏ß‡∏î‡∏á‡∏≤‡∏ô ${ms.no} ¬∑ ${ms.plan}</span>
              <span class="percent" style="background: ${bgGradient};">${ms.percent}%</span>
            </div>
            ${ms.description ? `<p>üìù ${ms.description}</p>` : ''}
            <p class="amount">üíµ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ : ${fmt(ms.amount)} ‡∏ö‡∏≤‡∏ó</p>
            ${paymentDateHtml}
          </div>
        `);
      });

      /* Animate progress bar */
      requestAnimationFrame(() => {
        card.querySelector('.progress-bar-inner')
            .style.width = Math.min(cumulative, 100) + '%';
      });

      return card;
    }

    function getMilestoneIcon(number) {
      const icons = ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];
      return icons[number - 1] || 'üìç';
    }

    /* ---------  Summary Dashboard  --------- */
    function buildSummaryDashboard(contracts) {
      const grid = document.getElementById('summary-grid');
      
      // Separate customer (BRS) and vendors
      const customer = contracts.find(c => c.name === 'BRS');
      const vendors = contracts.filter(c => c.name !== 'BRS');
      
      const totalReceivable = customer ? customer.total : 0;
      const totalPayable = vendors.reduce((sum, contract) => sum + contract.total, 0);
      const netCashFlow = totalReceivable - totalPayable;
      const profitMargin = totalReceivable > 0 ? ((netCashFlow / totalReceivable) * 100) : 0;
      
      grid.innerHTML = `
        <div class="summary-card" style="border-left: 4px solid var(--accent);">
          <div class="summary-number" style="color: var(--accent);">${fmt(totalReceivable)}</div>
          <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)</div>
          <div class="summary-detail">‡∏à‡∏≤‡∏Å BRS - ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</div>
        </div>
        <div class="summary-card" style="border-left: 4px solid #ef4444;">
          <div class="summary-number" style="color: #ef4444;">${fmt(totalPayable)}</div>
          <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ (‡∏ö‡∏≤‡∏ó)</div>
          <div class="summary-detail">${vendors.length} ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢</div>
        </div>
        <div class="summary-card" style="border-left: 4px solid ${netCashFlow >= 0 ? 'var(--accent)' : '#ef4444'};">
          <div class="summary-number" style="color: ${netCashFlow >= 0 ? 'var(--accent)' : '#ef4444'};">${fmt(Math.abs(netCashFlow))}</div>
          <div class="summary-label">${netCashFlow >= 0 ? '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥' : '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô'} (‡∏ö‡∏≤‡∏ó)</div>
          <div class="summary-detail">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö - ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
        </div>
        <div class="summary-card" style="border-left: 4px solid var(--primary);">
          <div class="summary-number" style="color: var(--primary);">${profitMargin.toFixed(1)}%</div>
          <div class="summary-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
          <div class="summary-detail">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
        </div>
        <div class="summary-card">
          <div class="summary-number">1</div>
          <div class="summary-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <div class="summary-detail">BRS (‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á)</div>
        </div>
        <div class="summary-card">
          <div class="summary-number">${vendors.length}</div>
          <div class="summary-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</div>
          <div class="summary-detail">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div>
        </div>
      `;
    }

    /* ---------  Chart Dashboard  --------- */
    function buildChartDashboard(contracts) {
      const chartContainer = document.getElementById('contract-chart').parentElement;
      
      // Separate customer and vendors
      const customer = contracts.find(c => c.name === 'BRS');
      const vendors = contracts.filter(c => c.name !== 'BRS');
      
      chartContainer.innerHTML = `
        <h2 style="margin-top: 0;">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö - ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
        
        <!-- Cash Flow Chart -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
          <div style="text-align: center;">
            <h3 style="color: var(--accent); margin-bottom: 1rem;">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
            <div style="background: var(--accent); color: white; padding: 2rem; border-radius: 12px; font-size: 1.5rem; font-weight: bold;">
              ${fmt(customer ? customer.total : 0)} ‡∏ö‡∏≤‡∏ó
            </div>
            <div style="margin-top: 1rem; color: var(--subtext);">BRS (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</div>
          </div>
          <div style="text-align: center;">
            <h3 style="color: #ef4444; margin-bottom: 1rem;">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</h3>
            <div style="background: #ef4444; color: white; padding: 2rem; border-radius: 12px; font-size: 1.5rem; font-weight: bold;">
              ${fmt(vendors.reduce((sum, v) => sum + v.total, 0))} ‡∏ö‡∏≤‡∏ó
            </div>
            <div style="margin-top: 1rem; color: var(--subtext);">${vendors.length} ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</div>
          </div>
        </div>

        <h3 style="color: var(--primary);">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</h3>
        <div class="chart" style="height: 200px;">
          ${vendors.map(vendor => {
            const maxValue = Math.max(...vendors.map(v => v.total));
            const height = (vendor.total / maxValue) * 150;
            return `
              <div class="chart-bar" style="height: ${height}px; background: #ef4444;">
                <div class="chart-bar-value">${fmt(vendor.total)}</div>
                <div class="chart-bar-label">${vendor.name}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }    /* ---------  Timeline Dashboard  --------- */
    function buildTimelineDashboard(contracts) {
      const container = document.getElementById('timeline-container');
      
      // Collect all milestones with proper dates and status
      const allMilestones = [];
      contracts.forEach(contract => {
        const isCustomer = contract.name === 'BRS';
        contract.milestones.forEach(milestone => {
          let sortDate;
          let displayDate = milestone.plan;
          let paymentDate = null;
          
          // Try to extract month/year for sorting
          if (milestone.plan.includes('‡∏°‡∏¥.‡∏¢. 68')) {
            sortDate = new Date('2025-06-30');
            displayDate = '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568';
          } else if (milestone.plan.includes('‡∏Å.‡∏Ñ. 68')) {
            sortDate = new Date('2025-07-31');
            displayDate = '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568';
          } else if (milestone.plan.includes('‡∏™.‡∏Ñ. 68')) {
            sortDate = new Date('2025-08-31');
            displayDate = '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2568';
          } else if (milestone.plan.includes('‡∏Å.‡∏¢. 68')) {
            sortDate = new Date('2025-09-30');
            displayDate = '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568';
          } else if (milestone.plan.includes('‡∏ò.‡∏Ñ. 68')) {
            sortDate = new Date('2025-12-31');
            displayDate = '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568';
          } else if (milestone.plan.includes('‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠')) {
            sortDate = new Date('2025-06-01');
            displayDate = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568)';
          } else {
            sortDate = new Date('2025-06-15');
            displayDate = milestone.plan;
          }
          
          // Get payment date for vendors
          if (!isCustomer && milestone.paymentDate) {
            paymentDate = milestone.paymentDate;
          }
          
          allMilestones.push({
            contract: contract.name,
            isCustomer: isCustomer,
            sortDate: sortDate,
            displayDate: displayDate,
            paymentDate: paymentDate,
            ...milestone,
            contractTotal: contract.total
          });
        });
      });

      // Sort by date
      allMilestones.sort((a, b) => a.sortDate - b.sortDate);

      // Group by month
      const monthGroups = {};
      allMilestones.forEach(milestone => {
        const monthKey = milestone.displayDate;
        if (!monthGroups[monthKey]) {
          monthGroups[monthKey] = {
            customer: [],
            vendors: [],
            totalReceivable: 0,
            totalPayable: 0
          };
        }
        
        if (milestone.isCustomer) {
          monthGroups[monthKey].customer.push(milestone);
          monthGroups[monthKey].totalReceivable += milestone.amount;
        } else {
          monthGroups[monthKey].vendors.push(milestone);
          monthGroups[monthKey].totalPayable += milestone.amount;
        }
      });

            container.innerHTML = `
        <!-- Timeline Overview Header -->
        <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; text-align: center; box-shadow: var(--shadow-hover);">
          <h2 style="margin: 0 0 1rem; font-size: 2rem; font-weight: 600;">‚è±Ô∏è ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
          <p style="margin: 0; opacity: 0.9; font-size: 1.1rem;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</p>
        </div>
      ` + 
      
      Object.keys(monthGroups).map((month, index) => {
        const group = monthGroups[month];
        const netFlow = group.totalReceivable - group.totalPayable;
        const netColor = netFlow >= 0 ? 'var(--accent)' : '#ef4444';
        const netIcon = netFlow >= 0 ? 'üìà' : 'üìâ';
        const netBg = netFlow >= 0 ? 'rgba(6, 214, 160, 0.1)' : 'rgba(239, 68, 68, 0.1)';
        
        return `
          <div class="timeline-month" style="
            background: white; 
            border-radius: 20px; 
            margin-bottom: 2.5rem; 
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
          ">
            <!-- Month Header with Enhanced Design -->
            <div style="
              background: linear-gradient(135deg, ${netBg}, ${netBg}88);
              padding: 1.5rem 2rem;
              border-bottom: 1px solid var(--border);
              position: relative;
              overflow: hidden;
            ">
              <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: ${netColor}22; border-radius: 50%; opacity: 0.5;"></div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="
                    background: ${netColor}; 
                    color: white; 
                    width: 50px; 
                    height: 50px; 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 1.5rem; 
                    font-weight: bold;
                    box-shadow: 0 4px 12px ${netColor}40;
                  ">
                    ${index + 1}
                  </div>
                  <div>
                    <h3 style="margin: 0; color: var(--text); font-size: 1.6rem; font-weight: 600;">üìÖ ${month}</h3>
                    <p style="margin: 0.25rem 0 0; color: var(--subtext); font-size: 0.95rem;">
                      ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ${fmt(group.totalReceivable)} ‡∏ö‡∏≤‡∏ó ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢: ${fmt(group.totalPayable)} ‡∏ö‡∏≤‡∏ó
                    </p>
                  </div>
                </div>
                
                <div style="text-align: right; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                  <div style="font-size: 0.85rem; color: var(--subtext); margin-bottom: 0.25rem; font-weight: 500;">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                  <div style="font-size: 1.4rem; font-weight: bold; color: ${netColor}; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">${netIcon}</span>
                    ${fmt(Math.abs(netFlow))} ‡∏ö‡∏≤‡∏ó
                  </div>
                  <div style="font-size: 0.8rem; color: var(--subtext); margin-top: 0.25rem;">
                    ${netFlow >= 0 ? '‡∏Å‡∏≥‡πÑ‡∏£' : '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô'} ${((Math.abs(netFlow) / Math.max(group.totalReceivable, 1)) * 100).toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Content Grid with Enhanced Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
              <!-- Customer Receivables Section -->
              <div style="padding: 2rem; border-right: 1px solid var(--border); background: linear-gradient(to bottom, rgba(6, 214, 160, 0.02), rgba(6, 214, 160, 0.06));">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                  <div style="
                    background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
                    color: white; 
                    width: 40px; 
                    height: 40px; 
                    border-radius: 10px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 1.2rem;
                    box-shadow: 0 4px 12px rgba(6, 214, 160, 0.3);
                  ">üí∞</div>
                  <div>
                    <h4 style="margin: 0; color: var(--accent); font-size: 1.2rem; font-weight: 600;">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
                    <div style="font-size: 0.9rem; color: var(--subtext); font-weight: 500;">
                      ${group.customer.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${fmt(group.totalReceivable)} ‡∏ö‡∏≤‡∏ó
                    </div>
                  </div>
                </div>
                
                ${group.customer.length > 0 ? group.customer.map(milestone => `
                  <div style="
                    background: white; 
                    border-radius: 12px; 
                    padding: 1.25rem; 
                    margin-bottom: 1rem; 
                    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
                    border-left: 4px solid var(--accent);
                    transition: all 0.3s ease;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.06)'">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.75rem;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                          ${getMilestoneIcon(milestone.no)} 
                          <span>‡∏á‡∏ß‡∏î‡∏á‡∏≤‡∏ô ${milestone.no}</span>
                          <span style="background: var(--accent); color: white; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">${milestone.percent}%</span>
                        </div>
                        ${milestone.description ? `<div style="font-size: 0.9rem; color: var(--subtext); margin-bottom: 0.75rem; line-height: 1.4;">${milestone.description}</div>` : ''}
                      </div>
                    </div>
                    
                    <div style="display: flex; justify-content: between; align-items: center;">
                      <div style="font-weight: 700; color: var(--accent); font-size: 1.1rem;">
                        + ${fmt(milestone.amount)} ‡∏ö‡∏≤‡∏ó
                      </div>
                      <div style="background: rgba(6, 214, 160, 0.1); color: var(--accent); padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">
                        ‚úÖ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                      </div>
                    </div>
                  </div>
                `).join('') : `
                  <div style="
                    text-align: center; 
                    padding: 2rem; 
                    color: var(--subtext); 
                    font-style: italic;
                    background: rgba(255,255,255,0.7);
                    border-radius: 12px;
                    border: 2px dashed var(--border);
                  ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">üí∞</div>
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ
                  </div>
                `}
              </div>
              
              <!-- Vendor Payables Section -->
              <div style="padding: 2rem; background: linear-gradient(to bottom, rgba(239, 68, 68, 0.02), rgba(239, 68, 68, 0.06));">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                  <div style="
                    background: linear-gradient(135deg, #ef4444, #dc2626); 
                    color: white; 
                    width: 40px; 
                    height: 40px; 
                    border-radius: 10px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 1.2rem;
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                  ">üí∏</div>
                  <div>
                    <h4 style="margin: 0; color: #ef4444; font-size: 1.2rem; font-weight: 600;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</h4>
                    <div style="font-size: 0.9rem; color: var(--subtext); font-weight: 500;">
                      ${group.vendors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${fmt(group.totalPayable)} ‡∏ö‡∏≤‡∏ó
                    </div>
                  </div>
                </div>
                
                ${group.vendors.length > 0 ? group.vendors.map(milestone => {
                  let paymentInfo = '';
                  let paymentBadge = '';
                  if (milestone.paymentDate) {
                    const dateInfo = formatDate(milestone.paymentDate);
                    const badgeColors = {
                      'overdue': { bg: '#fee2e2', color: '#dc2626', border: '#fca5a5' },
                      'urgent': { bg: '#fef3c7', color: '#d97706', border: '#fcd34d' },
                      'soon': { bg: '#dbeafe', color: '#2563eb', border: '#93c5fd' },
                      'normal': { bg: '#dcfce7', color: '#059669', border: '#86efac' }
                    };
                    const colors = badgeColors[dateInfo.class];
                    
                    paymentInfo = `
                      <div style="
                        background: ${colors.bg}; 
                        color: ${colors.color}; 
                        padding: 0.5rem 0.75rem; 
                        border-radius: 8px; 
                        font-size: 0.8rem; 
                        font-weight: 600;
                        border: 1px solid ${colors.border};
                        margin-top: 0.75rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                      ">
                        <span style="font-size: 1rem;">${dateInfo.icon}</span>
                        <div>
                          <div>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${dateInfo.formatted}</div>
                          ${dateInfo.daysLeft < 0 ? 
                            `<div style="font-size: 0.75rem; margin-top: 0.2rem;">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(dateInfo.daysLeft)} ‡∏ß‡∏±‡∏ô</div>` :
                            dateInfo.daysLeft <= 7 ? 
                            `<div style="font-size: 0.75rem; margin-top: 0.2rem;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${dateInfo.daysLeft} ‡∏ß‡∏±‡∏ô</div>` : ''
                          }
                        </div>
                      </div>
                    `;
                    
                    paymentBadge = `
                      <div style="background: ${colors.bg}; color: ${colors.color}; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; border: 1px solid ${colors.border};">
                        ${dateInfo.icon} ${dateInfo.daysLeft < 0 ? '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : dateInfo.daysLeft <= 7 ? '‡∏î‡πà‡∏ß‡∏ô' : '‡∏õ‡∏Å‡∏ï‡∏¥'}
                      </div>
                    `;
                  }
                  
                  return `
                    <div style="
                      background: white; 
                      border-radius: 12px; 
                      padding: 1.25rem; 
                      margin-bottom: 1rem; 
                      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
                      border-left: 4px solid #ef4444;
                      transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.06)'">
                      <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.75rem;">
                        <div style="flex: 1;">
                          <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">
                            ${getMilestoneIcon(milestone.no)} ${milestone.contract}
                          </div>
                          <div style="font-size: 0.9rem; color: var(--subtext); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‡∏á‡∏ß‡∏î‡∏á‡∏≤‡∏ô ${milestone.no}</span>
                            <span style="background: #ef4444; color: white; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">${milestone.percent}%</span>
                          </div>
                          ${milestone.description ? `<div style="font-size: 0.85rem; color: var(--subtext); margin-bottom: 0.75rem; line-height: 1.4;">${milestone.description}</div>` : ''}
                        </div>
                      </div>
                      
                      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: ${paymentInfo ? '0' : '0'};">
                        <div style="font-weight: 700; color: #ef4444; font-size: 1.1rem;">
                          - ${fmt(milestone.amount)} ‡∏ö‡∏≤‡∏ó
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          ${paymentBadge}
                          <div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">
                            üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                          </div>
                        </div>
                      </div>
                      ${paymentInfo}
                    </div>
                  `;
                }).join('') : `
                  <div style="
                    text-align: center; 
                    padding: 2rem; 
                    color: var(--subtext); 
                    font-style: italic;
                    background: rgba(255,255,255,0.7);
                    border-radius: 12px;
                    border: 2px dashed var(--border);
                  ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">üí∏</div>
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }    /* ---------  Cash Flow Dashboard  --------- */
    function buildCashFlowDashboard(contracts) {
      const container = document.getElementById('cashflow-container');
      
      const customer = contracts.find(c => c.name === 'BRS');
      const vendors = contracts.filter(c => c.name !== 'BRS');
      
      // Create monthly cash flow data with proper dates
      const monthlyFlow = {};
      const months = [
        { key: '2025-06', name: '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568', short: '‡∏°‡∏¥.‡∏¢.' },
        { key: '2025-07', name: '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568', short: '‡∏Å.‡∏Ñ.' },
        { key: '2025-08', name: '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2568', short: '‡∏™.‡∏Ñ.' },
        { key: '2025-09', name: '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568', short: '‡∏Å.‡∏¢.' },
        { key: '2025-10', name: '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2568', short: '‡∏ï.‡∏Ñ.' },
        { key: '2025-11', name: '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2568', short: '‡∏û.‡∏¢.' },
        { key: '2025-12', name: '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568', short: '‡∏ò.‡∏Ñ.' }
      ];
      
      // Initialize months
      months.forEach(month => {
        monthlyFlow[month.key] = {
          name: month.name,
          receivable: 0,
          payable: 0,
          net: 0,
          receivableItems: [],
          payableItems: []
        };
      });
      
      // Map customer receivables
      if (customer) {
        customer.milestones.forEach(milestone => {
          let monthKey = '2025-06'; // default
          
          if (milestone.plan.includes('‡∏Å.‡∏Ñ. 68')) monthKey = '2025-07';
          else if (milestone.plan.includes('‡∏™.‡∏Ñ. 68')) monthKey = '2025-08';
          else if (milestone.plan.includes('‡∏Å.‡∏¢. 68')) monthKey = '2025-09';
          else if (milestone.plan.includes('‡∏ï.‡∏Ñ. 68')) monthKey = '2025-10';
          else if (milestone.plan.includes('‡∏û.‡∏¢. 68')) monthKey = '2025-11';
          else if (milestone.plan.includes('‡∏ò.‡∏Ñ. 68')) monthKey = '2025-12';
          
          if (monthlyFlow[monthKey]) {
            monthlyFlow[monthKey].receivable += milestone.amount;
            monthlyFlow[monthKey].receivableItems.push(milestone);
          }
        });
      }
      
      // Map vendor payables by payment date
      vendors.forEach(vendor => {
        vendor.milestones.forEach(milestone => {
          let monthKey = '2025-06'; // default
          
          if (milestone.paymentDate) {
            const date = new Date(milestone.paymentDate);
            monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          } else if (milestone.plan.includes('‡∏Å.‡∏Ñ. 68')) {
            monthKey = '2025-07';
          } else if (milestone.plan.includes('‡∏™.‡∏Ñ. 68')) {
            monthKey = '2025-08';
          } else if (milestone.plan.includes('‡∏Å.‡∏¢. 68')) {
            monthKey = '2025-09';
          } else if (milestone.plan.includes('‡∏ò.‡∏Ñ. 68')) {
            monthKey = '2025-12';
          }
          
          if (monthlyFlow[monthKey]) {
            monthlyFlow[monthKey].payable += milestone.amount;
            monthlyFlow[monthKey].payableItems.push({
              ...milestone,
              vendor: vendor.name
            });
          }
        });
      });
      
      // Calculate net flow and cumulative
      let cumulativeFlow = 0;
      months.forEach(month => {
        if (monthlyFlow[month.key]) {
          monthlyFlow[month.key].net = monthlyFlow[month.key].receivable - monthlyFlow[month.key].payable;
          cumulativeFlow += monthlyFlow[month.key].net;
          monthlyFlow[month.key].cumulative = cumulativeFlow;
        }
      });
      
      const totalReceivable = customer ? customer.total : 0;
      const totalPayable = vendors.reduce((sum, v) => sum + v.total, 0);
      const totalProfit = totalReceivable - totalPayable;
        container.innerHTML = `
        <!-- Enhanced Summary Cards with Better Visual Hierarchy -->
        <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 3rem; text-align: center; box-shadow: var(--shadow-hover);">
          <h2 style="margin: 0 0 1rem; font-size: 2rem; font-weight: 600;">üìä ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
          <p style="margin: 0; opacity: 0.9; font-size: 1.1rem;">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
          <!-- Total Receivable Card -->
          <div style="
            background: linear-gradient(135deg, var(--accent), #059669); 
            color: white; 
            padding: 2.5rem; 
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 12px 40px rgba(6, 214, 160, 0.3);
            position: relative;
            overflow: hidden;
          ">
            <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.7;"></div>
            <div style="position: relative; z-index: 1;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üí∞</div>
              <h3 style="margin: 0 0 1rem; opacity: 0.95; font-size: 1.2rem; font-weight: 500;">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
              <div style="font-size: 2.4rem; font-weight: bold; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${fmt(totalReceivable)}</div>
              <div style="opacity: 0.9; font-size: 1rem; font-weight: 500;">‡∏ö‡∏≤‡∏ó</div>
            </div>
          </div>
          
          <!-- Total Payable Card -->
          <div style="
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            padding: 2.5rem; 
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 12px 40px rgba(239, 68, 68, 0.3);
            position: relative;
            overflow: hidden;
          ">
            <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.7;"></div>
            <div style="position: relative; z-index: 1;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üí∏</div>
              <h3 style="margin: 0 0 1rem; opacity: 0.95; font-size: 1.2rem; font-weight: 500;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
              <div style="font-size: 2.4rem; font-weight: bold; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${fmt(totalPayable)}</div>
              <div style="opacity: 0.9; font-size: 1rem; font-weight: 500;">‡∏ö‡∏≤‡∏ó</div>
            </div>
          </div>
          
          <!-- Net Profit Card -->
          <div style="
            background: linear-gradient(135deg, ${totalProfit >= 0 ? 'var(--primary)' : '#8b5cf6'}, ${totalProfit >= 0 ? '#3730a3' : '#7c3aed'}); 
            color: white; 
            padding: 2.5rem; 
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 12px 40px ${totalProfit >= 0 ? 'rgba(102, 126, 234, 0.3)' : 'rgba(139, 92, 246, 0.3)'};
            position: relative;
            overflow: hidden;
          ">
            <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.7;"></div>
            <div style="position: relative; z-index: 1;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">${totalProfit >= 0 ? 'üìà' : 'üìâ'}</div>
              <h3 style="margin: 0 0 1rem; opacity: 0.95; font-size: 1.2rem; font-weight: 500;">${totalProfit >= 0 ? '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥' : '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'}</h3>
              <div style="font-size: 2.4rem; font-weight: bold; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${fmt(Math.abs(totalProfit))}</div>
              <div style="opacity: 0.9; font-size: 1rem; font-weight: 500;">
                ‡∏ö‡∏≤‡∏ó <span style="background: rgba(255,255,255,0.2); padding: 0.3rem 0.6rem; border-radius: 12px; margin-left: 0.5rem;">${((totalProfit / totalReceivable) * 100).toFixed(1)}%</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Monthly Cash Flow Chart -->
        <div style="background: white; border-radius: 20px; padding: 2.5rem; margin-bottom: 3rem; box-shadow: var(--shadow);">
          <div style="text-align: center; margin-bottom: 2rem;">
            <h3 style="margin: 0 0 0.5rem; color: var(--primary); font-size: 1.8rem; font-weight: 600;">üìä ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <p style="margin: 0; color: var(--subtext); font-size: 1rem;">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
          </div>
          
          <!-- Enhanced Visual Chart -->
          <div style="
            background: linear-gradient(135deg, #f8fafc, #e2e8f0); 
            border-radius: 16px; 
            padding: 2.5rem; 
            margin-bottom: 2.5rem; 
            overflow-x: auto;
            border: 1px solid var(--border);
          ">
            <div style="display: flex; align-items: end; height: 250px; gap: 1.5rem; min-width: 700px; position: relative;">
              <!-- Grid Lines -->
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; pointer-events: none;">
                ${[0, 1, 2, 3, 4].map(i => `
                  <div style="position: absolute; top: ${i * 20}%; left: 0; right: 0; height: 1px; background: rgba(0,0,0,0.05);"></div>
                `).join('')}
              </div>
              
              ${months.map(month => {
                const data = monthlyFlow[month.key];
                if (!data || (data.receivable === 0 && data.payable === 0)) return '';
                
                const maxValue = Math.max(...months.map(m => Math.max(monthlyFlow[m.key]?.receivable || 0, monthlyFlow[m.key]?.payable || 0)));
                const receivableHeight = maxValue > 0 ? (data.receivable / maxValue) * 200 : 0;
                const payableHeight = maxValue > 0 ? (data.payable / maxValue) * 200 : 0;
                const netColor = data.net >= 0 ? 'var(--accent)' : '#ef4444';
                
                return `
                  <div style="flex: 1; min-width: 90px; text-align: center; position: relative;">
                    <!-- Chart Bars -->
                    <div style="display: flex; align-items: end; gap: 6px; height: 200px; margin-bottom: 1.5rem; justify-content: center; position: relative;">
                      <!-- Receivable Bar -->
                      <div style="
                        width: 28px; 
                        background: linear-gradient(to top, var(--accent), #34d399); 
                        height: ${receivableHeight}px; 
                        border-radius: 6px 6px 0 0; 
                        position: relative;
                        box-shadow: 0 4px 12px rgba(6, 214, 160, 0.3);
                        transition: all 0.3s ease;
                      " 
                      title="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ${fmt(data.receivable)}"
                      onmouseover="this.style.transform='scale(1.05)'"
                      onmouseout="this.style.transform='scale(1)'">
                        ${receivableHeight > 40 ? `
                          <div style="
                            position: absolute; 
                            top: -25px; 
                            left: 50%; 
                            transform: translateX(-50%); 
                            font-size: 0.7rem; 
                            font-weight: bold; 
                            color: var(--accent);
                            background: white;
                            padding: 0.2rem 0.5rem;
                            border-radius: 4px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            white-space: nowrap;
                          ">+${(data.receivable/1000000).toFixed(1)}M</div>
                        ` : ''}
                      </div>
                      
                      <!-- Payable Bar -->
                      <div style="
                        width: 28px; 
                        background: linear-gradient(to top, #ef4444, #f87171); 
                        height: ${payableHeight}px; 
                        border-radius: 6px 6px 0 0; 
                        position: relative;
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                        transition: all 0.3s ease;
                      " 
                      title="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢: ${fmt(data.payable)}"
                      onmouseover="this.style.transform='scale(1.05)'"
                      onmouseout="this.style.transform='scale(1)'">
                        ${payableHeight > 40 ? `
                          <div style="
                            position: absolute; 
                            top: -25px; 
                            left: 50%; 
                            transform: translateX(-50%); 
                            font-size: 0.7rem; 
                            font-weight: bold; 
                            color: #ef4444;
                            background: white;
                            padding: 0.2rem 0.5rem;
                            border-radius: 4px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            white-space: nowrap;
                          ">-${(data.payable/1000000).toFixed(1)}M</div>
                        ` : ''}
                      </div>
                    </div>
                    
                    <!-- Month Label -->
                    <div style="
                      font-size: 0.9rem; 
                      font-weight: 600; 
                      color: var(--text); 
                      margin-bottom: 0.5rem;
                      background: white;
                      padding: 0.4rem 0.8rem;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    ">${month.short}</div>
                    
                    <!-- Net Flow -->
                    <div style="
                      font-size: 0.8rem; 
                      color: ${netColor}; 
                      font-weight: 700;
                      background: ${netColor}15;
                      padding: 0.3rem 0.6rem;
                      border-radius: 6px;
                      border: 1px solid ${netColor}40;
                    ">
                      ${data.net >= 0 ? '+' : ''}${(data.net/1000000).toFixed(1)}M
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <!-- Enhanced Legend -->
            <div style="
              display: flex; 
              justify-content: center; 
              gap: 3rem; 
              margin-top: 2rem; 
              font-size: 1rem;
              background: white;
              padding: 1rem 2rem;
              border-radius: 12px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            ">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 20px; height: 20px; background: linear-gradient(135deg, var(--accent), #34d399); border-radius: 6px; box-shadow: 0 2px 4px rgba(6, 214, 160, 0.3);"></div>
                <span style="font-weight: 600; color: var(--text);">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #ef4444, #f87171); border-radius: 6px; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);"></div>
                <span style="font-weight: 600; color: var(--text);">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Monthly Details Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 2rem;">
            ${months.map(month => {
              const data = monthlyFlow[month.key];
              if (!data || (data.receivable === 0 && data.payable === 0)) return '';
              
              const netColor = data.net >= 0 ? 'var(--accent)' : '#ef4444';
              const netIcon = data.net >= 0 ? 'üìà' : 'üìâ';
              const netBg = data.net >= 0 ? 'rgba(6, 214, 160, 0.05)' : 'rgba(239, 68, 68, 0.05)';
              
              return `
                <div style="
                  background: white; 
                  border-radius: 16px; 
                  padding: 2rem; 
                  box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
                  border-left: 5px solid ${netColor};
                  transition: all 0.3s ease;
                  border: 1px solid var(--border);
                " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.08)'">
                  
                  <!-- Month Header -->
                  <div style="
                    display: flex; 
                    justify-content: between; 
                    align-items: center; 
                    margin-bottom: 1.5rem; 
                    padding-bottom: 1rem; 
                    border-bottom: 2px solid var(--border);
                    background: ${netBg};
                    margin: -2rem -2rem 1.5rem -2rem;
                    padding: 1.5rem 2rem;
                    border-radius: 16px 16px 0 0;
                  ">
                    <div>
                      <h4 style="margin: 0; color: var(--primary); font-size: 1.3rem; font-weight: 600;">${data.name}</h4>
                      <div style="font-size: 0.9rem; color: var(--subtext); margin-top: 0.25rem;">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.receivableItems.length + data.payableItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                      </div>
                    </div>
                    <div style="text-align: right; background: white; padding: 1rem 1.25rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                      <div style="font-size: 0.85rem; color: var(--subtext); margin-bottom: 0.25rem; font-weight: 500;">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                      <div style="font-weight: bold; color: ${netColor}; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>${netIcon}</span>
                        ${fmt(Math.abs(data.net))}
                      </div>
                    </div>
                  </div>
                  
                  <!-- Enhanced Content Grid -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Receivables -->
                    <div>
                      <h5 style="
                        margin: 0 0 1rem; 
                        color: var(--accent); 
                        font-size: 1rem; 
                        font-weight: 600;
                        display: flex; 
                        align-items: center; 
                        gap: 0.5rem;
                        background: rgba(6, 214, 160, 0.1);
                        padding: 0.75rem;
                        border-radius: 10px;
                      ">
                        <span style="font-size: 1.2rem;">üí∞</span>
                        <div>
                          <div>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
                          <div style="font-size: 0.8rem; font-weight: 500; opacity: 0.8;">${fmt(data.receivable)} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                      </h5>
                      ${data.receivableItems.length > 0 ? data.receivableItems.map(item => `
                        <div style="
                          font-size: 0.85rem; 
                          color: var(--subtext); 
                          margin-bottom: 0.5rem;
                          background: rgba(6, 214, 160, 0.05);
                          padding: 0.75rem;
                          border-radius: 8px;
                          border-left: 3px solid var(--accent);
                        ">
                          <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">
                            ‚Ä¢ ‡∏á‡∏ß‡∏î ${item.no} (${item.percent}%)
                          </div>
                          <div style="color: var(--accent); font-weight: 600;">${fmt(item.amount)} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                      `).join('') : '<div style="font-size: 0.85rem; color: var(--subtext); font-style: italic; text-align: center; padding: 1rem; background: rgba(0,0,0,0.02); border-radius: 8px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>'}
                    </div>
                    
                    <!-- Payables -->
                    <div>
                      <h5 style="
                        margin: 0 0 1rem; 
                        color: #ef4444; 
                        font-size: 1rem; 
                        font-weight: 600;
                        display: flex; 
                        align-items: center; 
                        gap: 0.5rem;
                        background: rgba(239, 68, 68, 0.1);
                        padding: 0.75rem;
                        border-radius: 10px;
                      ">
                        <span style="font-size: 1.2rem;">üí∏</span>
                        <div>
                          <div>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
                          <div style="font-size: 0.8rem; font-weight: 500; opacity: 0.8;">${fmt(data.payable)} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                      </h5>
                      ${data.payableItems.length > 0 ? data.payableItems.map(item => {
                        let paymentStatusBadge = '';
                        if (item.paymentDate) {
                          const dateInfo = formatDate(item.paymentDate);
                          const badgeColors = {
                            'overdue': { bg: '#fee2e2', color: '#dc2626' },
                            'urgent': { bg: '#fef3c7', color: '#d97706' },
                            'soon': { bg: '#dbeafe', color: '#2563eb' },
                            'normal': { bg: '#dcfce7', color: '#059669' }
                          };
                          const colors = badgeColors[dateInfo.class];
                          paymentStatusBadge = `
                            <div style="
                              background: ${colors.bg}; 
                              color: ${colors.color}; 
                              padding: 0.3rem 0.6rem; 
                              border-radius: 6px; 
                              font-size: 0.75rem; 
                              font-weight: 600;
                              margin-top: 0.5rem;
                              display: inline-flex;
                              align-items: center;
                              gap: 0.3rem;
                            ">
                              ${dateInfo.icon} ${dateInfo.daysLeft < 0 ? '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : dateInfo.daysLeft <= 7 ? '‡∏î‡πà‡∏ß‡∏ô' : '‡∏õ‡∏Å‡∏ï‡∏¥'}
                            </div>
                          `;
                        }
                        return `
                          <div style="
                            font-size: 0.85rem; 
                            color: var(--subtext); 
                            margin-bottom: 0.5rem;
                            background: rgba(239, 68, 68, 0.05);
                            padding: 0.75rem;
                            border-radius: 8px;
                            border-left: 3px solid #ef4444;
                          ">
                            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">
                              ‚Ä¢ ${item.vendor}
                            </div>
                            <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.25rem;">${fmt(item.amount)} ‡∏ö‡∏≤‡∏ó</div>
                            ${paymentStatusBadge}
                          </div>
                        `;
                      }).join('') : '<div style="font-size: 0.85rem; color: var(--subtext); font-style: italic; text-align: center; padding: 1rem; background: rgba(0,0,0,0.02); border-radius: 8px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>'}
                    </div>
                  </div>
                  
                  <!-- Cumulative Flow Summary -->
                  <div style="
                    margin-top: 1.5rem; 
                    padding-top: 1.5rem; 
                    border-top: 2px solid var(--border); 
                    text-align: center;
                    background: ${data.cumulative >= 0 ? 'rgba(6, 214, 160, 0.05)' : 'rgba(239, 68, 68, 0.05)'};
                    margin-left: -2rem;
                    margin-right: -2rem;
                    margin-bottom: -2rem;
                    padding: 1.5rem 2rem 2rem 2rem;
                    border-radius: 0 0 16px 16px;
                  ">
                    <div style="font-size: 0.9rem; color: var(--subtext); margin-bottom: 0.5rem; font-weight: 500;">üíº ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
                    <div style="
                      font-weight: bold; 
                      color: ${data.cumulative >= 0 ? 'var(--accent)' : '#ef4444'}; 
                      font-size: 1.3rem;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      gap: 0.5rem;
                    ">
                      <span>${data.cumulative >= 0 ? 'üìà' : 'üìâ'}</span>
                      ${fmt(Math.abs(data.cumulative))} ‡∏ö‡∏≤‡∏ó
                    </div>
                  </div>
                </div>
              `;
            }).filter(html => html).join('')}
          </div>
        </div>
      `;
    }/* ---------  Helpers  --------- */
    function fmt(n) {
      return (+n).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }
    
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const today = new Date();
      const diffTime = date - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      const thaiDate = date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      let statusIcon = '';
      let statusClass = '';
      
      if (diffDays < 0) {
        statusIcon = '‚ö†Ô∏è';
        statusClass = 'overdue';
      } else if (diffDays <= 7) {
        statusIcon = 'üî•';
        statusClass = 'urgent';
      } else if (diffDays <= 30) {
        statusIcon = '‚è∞';
        statusClass = 'soon';
      } else {
        statusIcon = 'üìÖ';
        statusClass = 'normal';
      }
      
      return {
        formatted: thaiDate,
        icon: statusIcon,
        class: statusClass,
        daysLeft: diffDays
      };
    }
  </script>
</body>
</html>
